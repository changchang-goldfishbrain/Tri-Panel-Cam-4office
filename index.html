
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>Tri-Grid Native</title>
    
    <!-- Mobile Web App Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: white;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* 隱藏的原生輸入框 */
        #camera-input {
            display: none;
        }

        /* 網格容器 */
        #grid-container {
            flex: 1;
            display: grid;
            grid-template-rows: 1fr 1fr 1fr;
            width: 100%;
            background: #000;
        }

        /* 格子樣式 */
        .grid-slot {
            position: relative;
            width: 100%;
            height: 100%;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #111;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .grid-slot:last-child {
            border-bottom: none;
        }
        .grid-slot:active {
            background-color: #222;
        }

        /* 顯示的照片 */
        .slot-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            position: absolute;
            inset: 0;
            z-index: 10;
        }

        /* 空狀態圖示 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #666;
            z-index: 5;
            pointer-events: none;
        }
        .empty-state span {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* 底部控制列 */
        #toolbar {
            height: auto;
            min-height: 80px;
            background: #000;
            border-top: 1px solid #222;
            padding: 20px;
            padding-bottom: env(safe-area-inset-bottom, 20px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-primary {
            background: white;
            color: black;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .btn-secondary {
            background: #222;
            color: white;
            padding: 12px;
            border-radius: 50%;
        }
        .btn-disabled {
            opacity: 0.5;
            pointer-events: none;
            box-shadow: none;
        }

    </style>
</head>
<body>

    <!-- 隱藏的相機輸入 -->
    <!-- accept="image/*" capture="environment" 強制呼叫後鏡頭 -->
    <input type="file" id="camera-input" accept="image/*" capture="environment">

    <!-- 主網格 -->
    <div id="grid-container">
        <!-- 上 -->
        <div class="grid-slot" id="slot-0" onclick="triggerCamera(0)">
            <div class="empty-state">
                <i data-lucide="plus" class="w-8 h-8 opacity-50"></i>
                <span>Tap to Add</span>
            </div>
        </div>
        <!-- 中 -->
        <div class="grid-slot" id="slot-1" onclick="triggerCamera(1)">
            <div class="empty-state">
                <i data-lucide="plus" class="w-8 h-8 opacity-50"></i>
                <span>Tap to Add</span>
            </div>
        </div>
        <!-- 下 -->
        <div class="grid-slot" id="slot-2" onclick="triggerCamera(2)">
            <div class="empty-state">
                <i data-lucide="plus" class="w-8 h-8 opacity-50"></i>
                <span>Tap to Add</span>
            </div>
        </div>
    </div>

    <!-- 底部工具列 -->
    <div id="toolbar">
        <button onclick="resetApp()" class="btn-secondary">
            <i data-lucide="refresh-cw" class="w-6 h-6"></i>
        </button>

        <div class="text-xs text-gray-500 font-mono" id="status-text">0 / 3</div>

        <button id="download-btn" onclick="downloadCollage()" class="btn-primary btn-disabled">
            <i data-lucide="download" class="w-5 h-5"></i>
            <span>儲存拼貼</span>
        </button>
    </div>

    <!-- 隱藏畫布用於生成圖片 -->
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        // 初始化圖示
        lucide.createIcons();

        // 狀態
        let images = [null, null, null]; // 存放 Base64 或 Blob URL
        let activeSlotIndex = -1;
        const input = document.getElementById('camera-input');
        const slots = [
            document.getElementById('slot-0'),
            document.getElementById('slot-1'),
            document.getElementById('slot-2')
        ];
        const downloadBtn = document.getElementById('download-btn');
        const statusText = document.getElementById('status-text');

        // 1. 觸發相機
        function triggerCamera(index) {
            activeSlotIndex = index;
            // 觸發隱藏的 input click
            input.click(); 
        }

        // 2. 監聽照片輸入
        input.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(evt) {
                    const dataUrl = evt.target.result;
                    
                    // 儲存數據
                    images[activeSlotIndex] = dataUrl;
                    
                    // 更新 UI
                    updateSlotUI(activeSlotIndex, dataUrl);
                    checkCompletion();
                };
                
                reader.readAsDataURL(file);
            }
            // 重置 input 以便下次能觸發同一張照片(如果需要)
            input.value = ''; 
        });

        function updateSlotUI(index, src) {
            const slot = slots[index];
            
            // 清除舊圖
            const oldImg = slot.querySelector('.slot-image');
            if (oldImg) oldImg.remove();
            
            // 隱藏 Empty State
            const emptyState = slot.querySelector('.empty-state');
            if (emptyState) emptyState.style.display = 'none';

            // 建立新圖
            const img = document.createElement('img');
            img.src = src;
            img.className = 'slot-image';
            slot.appendChild(img);
        }

        function checkCompletion() {
            const count = images.filter(i => i !== null).length;
            statusText.innerText = `${count} / 3`;
            
            if (count === 3) {
                downloadBtn.classList.remove('btn-disabled');
            } else {
                downloadBtn.classList.add('btn-disabled');
            }
        }

        function resetApp() {
            if(!confirm('確定要清空所有照片嗎？')) return;
            
            images = [null, null, null];
            slots.forEach(slot => {
                const img = slot.querySelector('.slot-image');
                if (img) img.remove();
                const emptyState = slot.querySelector('.empty-state');
                if (emptyState) emptyState.style.display = 'flex';
            });
            checkCompletion();
        }

        // 3. 拼貼生成 (核心邏輯：視覺裁切 Visual Crop)
        // 為了達到 WYSIWYG，我們必須裁切照片的中心部分，使其比例符合格子比例
        async function downloadCollage() {
            if (images.some(i => i === null)) return;

            downloadBtn.innerText = '處理中...';
            
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            // 載入所有圖片
            const imgObjects = await Promise.all(images.map(src => loadImage(src)));
            
            // 我們假設最終寬度為 1080px (高品質)
            const finalWidth = 1080;
            
            // 計算每個格子在螢幕上的長寬比 (Visual Aspect Ratio)
            // 因為是均分三格，每個格子的高度是寬度的 1/3 左右 (視螢幕而定)
            // 為了簡化且美觀，我們強制設定拼貼結果為 9:16 的直式海報
            // 所以整張圖是 1080x1920，每一格就是 1080x640
            
            const slotHeight = 640; // 1920 / 3
            const totalHeight = 1920;
            
            canvas.width = finalWidth;
            canvas.height = totalHeight;
            
            // 填滿黑色背景
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, finalWidth, totalHeight);
            
            // 繪製每一格
            imgObjects.forEach((img, index) => {
                // 目標：從原圖(img)中裁切出一塊，填滿 1080x640 的區域 (Center Crop)
                
                const targetRatio = finalWidth / slotHeight; // 1080 / 640 ≈ 1.68
                const imgRatio = img.naturalWidth / img.naturalHeight;
                
                let sW, sH, sX, sY;
                
                if (imgRatio > targetRatio) {
                    // 圖片比格子寬 (Landscape vs Portrait slot) -> 裁掉左右
                    sH = img.naturalHeight;
                    sW = sH * targetRatio;
                    sX = (img.naturalWidth - sW) / 2;
                    sY = 0;
                } else {
                    // 圖片比格子高 (Portrait vs Landscape slot) -> 裁掉上下
                    sW = img.naturalWidth;
                    sH = sW / targetRatio;
                    sX = 0;
                    sY = (img.naturalHeight - sH) / 2;
                }
                
                // 繪製到 Canvas 的對應位置
                const destY = index * slotHeight;
                
                ctx.drawImage(
                    img, 
                    sX, sY, sW, sH, // Source crop
                    0, destY, finalWidth, slotHeight // Destination
                );
                
                // 畫分割線 (可選)
                if (index > 0) {
                    ctx.fillStyle = 'rgba(255,255,255,0.1)';
                    ctx.fillRect(0, destY, finalWidth, 2); // 2px 線條
                }
            });
            
            // 下載
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
            link.download = `TriGrid_${timestamp}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            downloadBtn.innerHTML = '<i data-lucide="download" class="w-5 h-5"></i><span>儲存拼貼</span>';
            lucide.createIcons();
        }

        function loadImage(src) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.src = src;
            });
        }
    </script>
</body>
</html>
    